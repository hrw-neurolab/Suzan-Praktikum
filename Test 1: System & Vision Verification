"""
Praktikum: Robot Control System
Test 1: System & Vision Verification 
Suzan Elmasry
11.Feb.2026
"""

import cv2
import mediapipe as mp
import sys
import time

# --- 1. SETUP ---
sys.path.append('./') 

try:
    from myLibs.ufactory.xarm_class_joint_space import xArm7
except ImportError:
    print(">>> WARNING: xArm Library issue. Running Vision Only.")
    xArm7 = None

ROBOT_IP = "10.2.134.152" 

# --- 2. ROBOT CONNECTION ---
print(">>> TEST 1: STARTUP...")
robot_connected = False
robot = None

if xArm7:
    try:
        print(f">>> Connecting to {ROBOT_IP}...")
        robot = xArm7(ROBOT_IP)
        robot.motion_enable(True)
        robot.set_mode(0)
        robot.set_state(0)
        robot_connected = True
        print(">>> SUCCESS: Robot Connected!")
    except Exception as e:
        print(f">>> NOTE: Robot not connected. Vision Only.")
else:
    print(">>> NOTE: Vision Only Mode.")

# --- 3. VISION SETUP ---
mp_hands = mp.solutions.hands
hands = mp_hands.Hands(max_num_hands=1, min_detection_confidence=0.7)
mp_draw = mp.solutions.drawing_utils

# --- 4. MAIN LOOP ---
cap = cv2.VideoCapture(0)

while cap.isOpened():
    success, image = cap.read()
    if not success: continue

    image = cv2.flip(image, 1)
    h, w, c = image.shape
    image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    results = hands.process(image_rgb)
    
    # GET ROBOT DATA 
    robot_text = "Robot: Disconnected"
    text_color = (0, 0, 255) # Red
    
    if robot_connected and robot:
        try:
            pos = robot.get_position()
            if pos:
                robot_text = f"Robot: X={int(pos[0])}, Y={int(pos[1])}, Z={int(pos[2])}"
                text_color = (0, 255, 0) # Green
        except:
            pass

    # --- HAND DATA ---
  
    hand_text = "Hand: Not Detected" 
    
    if results.multi_hand_landmarks:
        for hand_lms in results.multi_hand_landmarks:
            mp_draw.draw_landmarks(image, hand_lms, mp_hands.HAND_CONNECTIONS)
            
      
            lm = hand_lms.landmark[8] 
       
            cx, cy = int(lm.x * w), int(lm.y * h)
            cz = int(lm.z * w)

            hand_text = f"Hand: X={cx}, Y={cy}, Z={cz}"
            
            

    # --- UI DISPLAY ---
    cv2.putText(image, "TEST 1: VERIFICATION", (10, 30), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255, 255, 0), 2)
    cv2.putText(image, robot_text, (10, 70), cv2.FONT_HERSHEY_PLAIN, 1.5, text_color, 2)
    cv2.putText(image, hand_text, (10, 100), cv2.FONT_HERSHEY_PLAIN, 1.5, (255, 0, 0), 2)
    
    cv2.imshow('Test 1', image)
    
    if cv2.waitKey(5) & 0xFF == ord('q'):
        break

# --- 5. CLEANUP ---
cap.release()
cv2.destroyAllWindows()
if robot_connected and robot:
    robot.disconnect()
